import{P as I}from"./PlayerImg-60d274bb.js";import{_ as L,r as P,o as p,c as d,a as _,n as A,b as B,d as n,t as b,e as W,F as k,f as $,N as R,g as M,h as O}from"./index-6c430f66.js";const G={name:"Player",components:{PlayerImg:I},props:{isLeftWard:Boolean,playerStyle:String,playerName:String},emits:["moveBall","playerLoaded"]};function z(e,t,s,o,l,i){const y=P("PlayerImg");return p(),d("div",null,[_(y,{class:A(s.isLeftWard?"player-leftWard":"player-rightWard"),style:B(s.playerStyle),onClick:t[0]||(t[0]=a=>e.$emit("moveBall")),onLoad:t[1]||(t[1]=a=>e.$emit("playerLoaded"))},null,8,["class","style"]),n("p",null,b(s.playerName),1)])}const E=L(G,[["render",z]]);const q={name:"Ball",props:{posx:Number,posy:Number,moveDur:Number},computed:{ballStyle(){return`transform:translate(${this.posx}vw, ${this.posy}rem); transition: ${this.moveDur}s ease-out`}}};function U(e,t,s,o,l,i){return p(),d("img",{class:"ball",src:W,style:B(i.ballStyle)},null,4)}const F=L(q,[["render",U]]);const X={props:{throwNum:Number,score:Array}},Y={class:"score-board"},V={class:"score-row"};function H(e,t,s,o,l,i){return p(),d("div",Y,[n("p",null,"目前球数："+b(s.throwNum),1),t[0]||(t[0]=n("p",null,"排行榜：",-1)),n("ol",null,[(p(),d(k,null,$(3,y=>n("li",{key:y},[n("div",V,[n("div",null,b(s.score[y-1].player),1),n("div",null,b(s.score[y-1].value),1)])])),64))])])}const j=L(X,[["render",H]]),J={rect:{mode1:["3 / 2 / auto / 4","2 / 1","2 / 4","1 / 2 / auto / 4","3 / 3","1 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"],mode2:["3 / 2","2 / 1 / 4","2 / 4 / 4","1 / 2","3 / 3 / auto / 5","1 / 4 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"]},modeMap:{3:[],4:[],5:[0],6:[0,3],7:[0,1,2,5],8:[0,1,2,3],9:[1,2,3,4]}},K=e=>{const t=e.map(s=>s*Math.random());return t.indexOf(Math.max(...t))},Q=e=>{const t=[...e],s=[...e];t.sort((y,a)=>a-y);const o=s.indexOf(t[0]);s[o]=void 0;const l=s.indexOf(t[1]);s[l]=void 0;const i=s.indexOf(t[2]);return s[i]=void 0,[o,l,i]},Z=e=>new Promise(t=>{setTimeout(t,e)}),v={playerLayout:J,getRandomIdx:K,getTopIdx:Q,sleep:Z};const D=16,S=67,ee=5,T=1e3,te=5e3,w={playerPos:{}},se={components:{ScoreBoard:j,NavButton:R,Player:E,Ball:F},data(){return{score:{throwCounts:0,playerCounts:[0,0,0,0,0,0,0,0,0]},gameOver:!1,totalPassLimit:30,topPlayerIdx:null,topPlayerLimit:null,topPlayerSchedule:[],lastPlayer0Throw:null,endMsg:"",trainingMode:!1,showIntro:!0,showLoading:!1,waitSeconds:6,surveyUrl:"https://www.baidu.com",player:{num:3,numInput:3,turnDur:0,filter:"sepia(1) saturate(20)",hue:180,gray:0,name:["player","player1","player2","player3","player4","player5","player6","player7","player8"],isLeftWard:[!1,!1,!0,!1,!0,!0,!1,!0,!1,!0],refs:[]},ball:{pos:[-10,-10],moveDur:0,owner:void 0}}},computed:{scoreRank(){const[e,t,s]=v.getTopIdx(this.score.playerCounts);return[{player:this.player.name[e],value:this.score.playerCounts[e]},{player:this.player.name[t],value:this.score.playerCounts[t]},{player:this.player.name[s],value:this.score.playerCounts[s]}]},playerStyle(){const e=(s,o,l)=>`filter: ${this.player.filter} hue-rotate(${s}deg) grayscale(${o}%); transition:${l}s linear`,t=[e(this.player.hue,this.player.gray,this.player.turnDur)];for(let s=1;s<this.player.num;s++)Number(this.player.num)===3&&s===1?t.push("filter: sepia(1) saturate(12) hue-rotate(190deg) brightness(0.95) contrast(1.15) grayscale(0%); transition:0s linear"):Number(this.player.num)===3&&s===2?t.push("filter: sepia(1) saturate(12) hue-rotate(330deg) brightness(1.0) contrast(1.10) grayscale(0%); transition:0s linear"):t.push(e(Math.random()*360,Math.random()*100,0));return t},gridArea(){const e=s=>v.playerLayout.modeMap[this.player.num].includes(s)?`grid-area: ${v.playerLayout.rect.mode2[s]}`:`grid-area: ${v.playerLayout.rect.mode1[s]}`,t=[];for(let s=0;s<this.player.num;s++)t.push(e(s));return t}},methods:{loadConfigs(){this.player.name[0]=this.$store.getters.playerName||this.player.name[0],this.player.hue=this.$store.getters.playerHue||this.player.hue,this.player.gray=this.$store.getters.playerGray||this.player.gray;const e=Number(this.$store.getters.playerNum);!Number.isNaN(e)&&e>=3&&e<=9&&(this.player.num=e,this.player.numInput=e)},scoreCounter(e){if(this.gameOver)return;if(this.trainingMode){this.score.throwCounts++,this.score.playerCounts[e]++,e===0&&(Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0&&this.topPlayerSchedule[0]===this.score.throwCounts&&this.topPlayerSchedule.shift(),this.lastPlayer0Throw=this.score.throwCounts);return}this.score.throwCounts++,this.score.playerCounts[e]++,e===0&&(Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0&&this.topPlayerSchedule[0]===this.score.throwCounts&&this.topPlayerSchedule.shift(),this.lastPlayer0Throw=this.score.throwCounts),this.score.throwCounts>=this.totalPassLimit&&(this.gameOver=!0,this.ball.moveDur=0,this.endMsg=`总传球数：${this.score.throwCounts}/${this.totalPassLimit}；你的接球数：${this.score.playerCounts[0]}`)},watchWindowResize(){window.addEventListener("resize",()=>{w.playerPos={},this.updateBallPosOnResize()},!1)},onPlayerTurn(e){const t=e.clientX;for(const s of[0]){const o=this.setPlayerDirection(t,s);if(o===-1)break;if(this.ball.owner==s){const l=o?-S:S;this.shiftBallPos(l,this.player.turnDur)}}},setPlayerRef(e){e&&this.player.refs.push(e.$el.childNodes[0])},setPlayerDirection(e,t){var o;if(!((o=this.player.refs[t])!=null&&o.offsetLeft))return-1;const s=e<this.player.refs[t].offsetLeft;return s==this.player.isLeftWard[t]?-1:(this.player.isLeftWard[t]=s,s)},getPlayerPos(e){var l,i;if(w.playerPos[e])return w.playerPos[e];const t=this.player.refs[e];if(!t)return console.log("reference error!"),[void 0,void 0];let s=(l=t.getClientRects()[0])==null?void 0:l.left,o=(i=t.getClientRects()[0])==null?void 0:i.top;return s!==void 0&&o!==void 0&&(w.playerPos[e]=[s,o]),[s,o]},getReceptorId(e){const t=this.player.num;let s=[];for(let a=0;a<t;a++)a!==e&&s.push(a);if(this.trainingMode){const a=Math.floor(Math.random()*s.length);return s[a]}const o=this.topPlayerIdx===0&&this.topPlayerLimit!==null&&this.score.playerCounts[0]>=this.topPlayerLimit,l=this.score.throwCounts+1,i=Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0;if(o)s=s.filter(a=>a!==0);else if(i){if(e!==0&&s.includes(0)&&this.topPlayerSchedule[0]===l)return 0;s=s.filter(a=>a!==0)}if(s.length===0)for(let a=0;a<t;a++)a!==e&&s.push(a);const y=Math.floor(Math.random()*s.length);return s[y]},applyAIIdentityForThree(){Number(this.player.num)===3&&(this.trainingMode?(this.player.name[1]="player1",this.player.name[2]="player2"):(this.player.name[1]="王佳琪",this.player.name[2]="刘明宇"))},getBallDx(e){let t=S;return this.player.isLeftWard[e]&&(t=0),t},onThrowBall(e){this.ball.owner==0&&this.throwBall(e)},async aiThrowBall(){if(this.gameOver)return;const e=this.getReceptorId(this.ball.owner),t=T+Math.floor(Math.random()*(te-T+1));await v.sleep(t),!this.gameOver&&this.throwBall(e)},throwBall(e=0,t=.5){if(this.gameOver)return"game over";if(this.ball.moveDur=t,e==this.ball.owner)return"don't need to move the ball";if(this.setBallPos(e),this.ball.owner=e,this.scoreCounter(e),this.gameOver)return"game over";this.ball.owner>0&&this.aiThrowBall()},setBallPos(e){const t=this.getBallDx(e),[s,o]=this.getPlayerPos(e);if(!s||!o)return;const l=(s+t)/(window.innerWidth/100),i=(o-ee)/D;this.ball.pos=[l,i]},resetBallPos(){this.ball.pos=[50-32/2/(window.innerWidth/100),(window.innerHeight-32)/D/2]},updateBallPosOnResize(){this.ball.moveDur=0,this.ball.owner||this.resetBallPos(),this.setBallPos(this.ball.owner)},shiftBallPos(e,t){this.ball.moveDur=t,this.ball.pos[0]+=e/(window.innerWidth/100)},initTopPlayerLimit(){var e,t,s;try{this.topPlayerIdx=0;const o=new URLSearchParams(window.location.search||""),l=h=>{const m=["cfg","k","limit"];let g=null;for(const x of m){const N=h.get?h.get(x):h[x];if(N!=null){g=N;break}}if(g===null)return NaN;const f=String(g).toLowerCase();if(f==="a"||f==="alpha")return 3;if(f==="b"||f==="beta")return 10;const C=Number(f);return Number.isNaN(C)?NaN:C},i=l(o),y=((e=this.$route)==null?void 0:e.query)||{},a=l({get:h=>y[h]}),u=Number(localStorage.getItem("cb_topPlayerLimit")),c=Number((s=(t=this.$store)==null?void 0:t.getters)==null?void 0:s.topPlayerLimit);let r;!Number.isNaN(i)&&i>0?r=i:!Number.isNaN(a)&&a>0?r=a:!Number.isNaN(u)&&u>0?r=u:!Number.isNaN(c)&&c>0?r=c:r=10,this.topPlayerLimit=r===3||r===10?r:10,localStorage.setItem("cb_topPlayerLimit",String(this.topPlayerLimit))}catch(o){console.warn("initTopPlayerLimit failed",o),this.topPlayerIdx=0,this.topPlayerLimit=10,localStorage.setItem("cb_topPlayerLimit","10")}finally{this.topPlayerSchedule=this.buildEvenSchedule(this.totalPassLimit,this.topPlayerLimit)}},buildEvenSchedule(e,t){try{if(!t||t<=0)return[];const s=t,o=[];for(let r=1;r<=s;r++)o.push(r*(e+1)/(s+1));const l=e/(s+1),i=Math.max(1,Math.floor(l*.35));let y=o.map(r=>{const h=Math.floor((Math.random()*2-1)*i),m=Math.round(r+h);return Math.min(Math.max(m,1),e)});y.sort((r,h)=>r-h);const a=Math.max(1,Math.floor(l*.4)),u=[];for(let r=0;r<s;r++){let h=y[r];if(r===0){const m=e-(s-1)*a;h=Math.min(h,Math.max(1,m))}else h=Math.max(h,u[r-1]+a);u.push(h)}let c=u[s-1]-e;if(c>0)for(let r=s-1;r>=0&&c>0;r--){const h=r>0?u[r-1]:0,m=r===0?1:h+a,g=Math.max(0,u[r]-m);if(g>0){const f=Math.min(g,c);u[r]-=f,c-=f}}for(let r=0;r<s;r++)r===0?u[r]=Math.min(Math.max(u[r],1),e-(s-1)*a):u[r]=Math.min(Math.max(u[r],u[r-1]+a),e-(s-1-r)*a);return u.map(r=>Math.round(r))}catch(s){return console.warn("buildEvenSchedule failed",s),[]}},onPlayerLoaded(e){e===0&&(this.showIntro||(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0))},async startGame(){this.showIntro=!1,this.trainingMode?this.showLoading=!1:(this.showLoading=!0,await v.sleep(this.waitSeconds*1e3),this.showLoading=!1),this.player.refs[0]?(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0):this.$nextTick(()=>{this.gameOver||(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0)})},restartGame(){this.gameOver=!1,this.endMsg="",this.score.throwCounts=0;for(let e=0;e<this.score.playerCounts.length;e++)this.score.playerCounts[e]=0;this.ball.moveDur=0,this.ball.owner=void 0,this.resetBallPos(),w.playerPos={},this.lastPlayer0Throw=null,this.initTopPlayerLimit()}},mounted(){this.loadConfigs(),this.watchWindowResize(),this.$nextTick(()=>{var s,o,l,i,y,a,u,c;this.initTopPlayerLimit(),this.trainingMode=((o=(s=this.$route)==null?void 0:s.query)==null?void 0:o.mode)==="training"||((i=(l=this.$store)==null?void 0:l.getters)==null?void 0:i.trainingMode)===!0;const e=Number((a=(y=this.$route)==null?void 0:y.query)==null?void 0:a.wait),t=Number((c=(u=this.$store)==null?void 0:u.getters)==null?void 0:c.waitSeconds);!Number.isNaN(e)&&e>0?this.waitSeconds=e:!Number.isNaN(t)&&t>0&&(this.waitSeconds=t),this.applyAIIdentityForThree()})},beforeUpdate(){this.player.refs=[]}},re={class:"game-page"},le={class:"main-page"},ae={key:0,class:"end-overlay"},oe={class:"end-modal"},ie={class:"intro-text"},ne={key:0},he={key:1},ue={key:1,class:"end-overlay"},ye={key:2,class:"end-overlay"},ce={class:"end-modal"},pe={class:"survey-placeholder"},de=["href"],me={key:1},fe={id:"menu-btn"};function ge(e,t,s,o,l,i){const y=P("Player"),a=P("Ball"),u=P("ScoreBoard"),c=P("NavButton");return p(),d("div",re,[t[7]||(t[7]=n("h1",null,"CyberBall",-1)),n("div",le,[n("div",{class:"players-wrap",onMousemove:t[0]||(t[0]=(...r)=>i.onPlayerTurn&&i.onPlayerTurn(...r))},[(p(!0),d(k,null,$(i.gridArea,(r,h)=>(p(),O(y,{key:h,ref_for:!0,ref:i.setPlayerRef,style:B(r),playerStyle:i.playerStyle[h],playerName:l.player.name[h],isLeftWard:l.player.isLeftWard[h],title:`分数：${l.score.playerCounts[h]}`,onMoveBall:m=>i.onThrowBall(h),onPlayerLoaded:m=>i.onPlayerLoaded(h)},null,8,["style","playerStyle","playerName","isLeftWard","title","onMoveBall","onPlayerLoaded"]))),128))],32)]),_(a,{posx:l.ball.pos[0],posy:l.ball.pos[1],moveDur:l.ball.moveDur},null,8,["posx","posy","moveDur"]),_(u,{throwNum:l.score.throwCounts,score:i.scoreRank},null,8,["throwNum","score"]),l.showIntro?(p(),d("div",ae,[n("div",oe,[t[4]||(t[4]=n("h2",null,"玩法说明",-1)),n("div",ie,[l.trainingMode?(p(),d("p",he,"现在进入练习环节，在屏幕上你会看到三个人物进行传球游戏。")):(p(),d("p",ne,"现在进入到正式的实验环节，在屏幕上你会看到三个人物进行传球游戏。")),t[2]||(t[2]=n("ul",null,[n("li",null,"屏幕底部的人物是你自己。"),n("li",null,"另外两个人物是在其它房间进行实验的另外两个人。"),n("li",null,"你们之间会互相进行传球，每一次你可以选择将球传给其中一人。")],-1)),t[3]||(t[3]=n("p",null,"准备好了请点击“进入游戏”。",-1))]),n("button",{onClick:t[1]||(t[1]=(...r)=>i.startGame&&i.startGame(...r))},"进入游戏")])])):M("",!0),l.showLoading&&!l.trainingMode?(p(),d("div",ue,[...t[5]||(t[5]=[n("div",{class:"end-modal"},[n("h2",null,"正在等待其他玩家准备中……"),n("div",{class:"loading-wrap"},[n("div",{class:"loading-spinner"}),n("div",{class:"loading-text"},"请稍候，游戏即将开始")])],-1)])])):M("",!0),l.gameOver?(p(),d("div",ye,[n("div",ce,[t[6]||(t[6]=n("h2",null,"游戏结束",-1)),n("p",null,b(l.endMsg),1),n("div",pe,[l.surveyUrl?(p(),d("a",{key:0,href:l.surveyUrl,target:"_blank",rel:"noopener"},"参与问卷",8,de)):(p(),d("span",me,"问卷链接占位"))]),_(c,{destination:"/",text:"返回"})])])):M("",!0),n("div",fe,[_(c,{destination:"/",text:"返回"})])])}const Pe=L(se,[["render",ge]]);export{Pe as default};
