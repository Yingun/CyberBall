import{P as A}from"./PlayerImg-7fb6d3c6.js";import{_ as b,r as P,o as m,c as f,a as N,n as E,b as k,d as h,t as L,e as I,F as D,f as T,N as R,g as M,h as G,i as U}from"./index-ab493bdc.js";const W={name:"Player",components:{PlayerImg:A},props:{isLeftWard:Boolean,playerStyle:String,playerName:String},emits:["moveBall","playerLoaded"]};function q(s,t,e,i,l,a){const n=P("PlayerImg");return m(),f("div",null,[N(n,{class:E(e.isLeftWard?"player-leftWard":"player-rightWard"),style:k(e.playerStyle),onClick:t[0]||(t[0]=o=>s.$emit("moveBall")),onLoad:t[1]||(t[1]=o=>s.$emit("playerLoaded"))},null,8,["class","style"]),h("p",null,L(e.playerName),1)])}const O=b(W,[["render",q]]);const F={name:"Ball",props:{posx:Number,posy:Number,moveDur:Number},computed:{ballStyle(){return`transform:translate(${this.posx}vw, ${this.posy}rem); transition: ${this.moveDur}s ease-out`}}};function z(s,t,e,i,l,a){return m(),f("img",{class:"ball",src:I,style:k(a.ballStyle)},null,4)}const X=b(F,[["render",z]]);const Y={props:{throwNum:Number,score:Array}},j={class:"score-board"},V={class:"score-row"};function H(s,t,e,i,l,a){return m(),f("div",j,[h("p",null,"目前球数："+L(e.throwNum),1),t[0]||(t[0]=h("p",null,"排行榜：",-1)),h("ol",null,[(m(),f(D,null,T(3,n=>h("li",{key:n},[h("div",V,[h("div",null,L(e.score[n-1].player),1),h("div",null,L(e.score[n-1].value),1)])])),64))])])}const J=b(Y,[["render",H]]),K={rect:{mode1:["3 / 2 / auto / 4","2 / 1","2 / 4","1 / 2 / auto / 4","3 / 3","1 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"],mode2:["3 / 2","2 / 1 / 4","2 / 4 / 4","1 / 2","3 / 3 / auto / 5","1 / 4 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"]},modeMap:{3:[],4:[],5:[0],6:[0,3],7:[0,1,2,5],8:[0,1,2,3],9:[1,2,3,4]}},Q=s=>{const t=s.map(e=>e*Math.random());return t.indexOf(Math.max(...t))},Z=s=>{const t=[...s],e=[...s];t.sort((n,o)=>o-n);const i=e.indexOf(t[0]);e[i]=void 0;const l=e.indexOf(t[1]);e[l]=void 0;const a=e.indexOf(t[2]);return e[a]=void 0,[i,l,a]},ee=s=>new Promise(t=>{setTimeout(t,s)}),_={playerLayout:K,getRandomIdx:Q,getTopIdx:Z,sleep:ee};const $=16,S=67,te=5,se=1e3,re=5e3,le=1e3,ie=2e3,v={playerPos:{}},ae={components:{ScoreBoard:J,NavButton:R,Player:O,Ball:X},data(){return{score:{throwCounts:0,playerCounts:[0,0,0,0,0,0,0,0,0]},gameOver:!1,totalPassLimit:30,topPlayerIdx:null,topPlayerLimit:null,topPlayerSchedule:[],lastPlayer0Throw:null,endMsg:"",trainingMode:!1,showIntro:!0,showLoading:!1,waitSeconds:6,surveyUrl:"",player:{num:3,numInput:3,turnDur:0,filter:"sepia(1) saturate(20)",hue:180,gray:0,name:["player","player1","player2","player3","player4","player5","player6","player7","player8"],isLeftWard:[!1,!1,!0,!1,!0,!0,!1,!0,!1,!0],refs:[]},ball:{pos:[-10,-10],moveDur:0,owner:void 0},loadingRemaining:0,loadingElapsed:0,loadingTimer:null,showAlmostStart:!1,effectiveWait:0,aiPresetNamesEnabled:!1}},computed:{scoreRank(){const[s,t,e]=_.getTopIdx(this.score.playerCounts);return[{player:this.player.name[s],value:this.score.playerCounts[s]},{player:this.player.name[t],value:this.score.playerCounts[t]},{player:this.player.name[e],value:this.score.playerCounts[e]}]},playerStyle(){const s=(e,i,l)=>`filter: ${this.player.filter} hue-rotate(${e}deg) grayscale(${i}%); transition:${l}s linear`,t=[s(this.player.hue,this.player.gray,this.player.turnDur)];for(let e=1;e<this.player.num;e++)Number(this.player.num)===3&&e===1?t.push("filter: sepia(1) saturate(12) hue-rotate(190deg) brightness(0.95) contrast(1.15) grayscale(0%); transition:0s linear"):Number(this.player.num)===3&&e===2?t.push("filter: sepia(1) saturate(12) hue-rotate(330deg) brightness(1.0) contrast(1.10) grayscale(0%); transition:0s linear"):t.push(s(Math.random()*360,Math.random()*100,0));return t},gridArea(){const s=e=>_.playerLayout.modeMap[this.player.num].includes(e)?`grid-area: ${_.playerLayout.rect.mode2[e]}`:`grid-area: ${_.playerLayout.rect.mode1[e]}`,t=[];for(let e=0;e<this.player.num;e++)t.push(s(e));return t}},methods:{loadConfigs(){var o,c,y,d,r,u,p,w,g;const s=((o=this.$route)==null?void 0:o.query)||{},t=s.name?String(s.name):null,e=s.hue!==void 0?Number(s.hue):null,i=s.gray!==void 0?Number(s.gray):null,l=s.num!==void 0?Number(s.num):null;this.player.name[0]=t&&t.length>0?t:((y=(c=this.$store)==null?void 0:c.getters)==null?void 0:y.playerName)||this.player.name[0],!Number.isNaN(e)&&e!==null?this.player.hue=e:this.player.hue=((r=(d=this.$store)==null?void 0:d.getters)==null?void 0:r.playerHue)||this.player.hue,!Number.isNaN(i)&&i!==null?this.player.gray=i:this.player.gray=((p=(u=this.$store)==null?void 0:u.getters)==null?void 0:p.playerGray)||this.player.gray;let a=Number((g=(w=this.$store)==null?void 0:w.getters)==null?void 0:g.playerNum),n=!Number.isNaN(l)&&l>=3&&l<=9?l:!Number.isNaN(a)&&a>=3&&a<=9?a:this.player.num;this.player.num=n,this.player.numInput=n},scoreCounter(s){if(this.gameOver)return;if(this.trainingMode){this.score.throwCounts++,this.score.playerCounts[s]++,s===0&&(Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0&&this.topPlayerSchedule[0]===this.score.throwCounts&&this.topPlayerSchedule.shift(),this.lastPlayer0Throw=this.score.throwCounts);return}this.score.throwCounts++,this.score.playerCounts[s]++,s===0&&(Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0&&this.topPlayerSchedule[0]===this.score.throwCounts?(console.log(`[DEBUG] 消耗计划项：第${this.score.throwCounts}次传球，玩家0接球成功`),this.topPlayerSchedule.shift()):console.log(`[DEBUG] 意外接球：第${this.score.throwCounts}次传球，玩家0接球但不在计划中`),this.lastPlayer0Throw=this.score.throwCounts),this.score.throwCounts>=this.totalPassLimit&&(this.gameOver=!0,this.ball.moveDur=0,this.endMsg=`总传球数：${this.score.throwCounts}/${this.totalPassLimit}；你的接球数：${this.score.playerCounts[0]}`)},watchWindowResize(){window.addEventListener("resize",()=>{v.playerPos={},this.updateBallPosOnResize()},!1)},onPlayerTurn(s){const t=s.clientX;for(const e of[0]){const i=this.setPlayerDirection(t,e);if(i===-1)break;if(this.ball.owner==e){const l=i?-S:S;this.shiftBallPos(l,this.player.turnDur)}}},setPlayerRef(s){s&&this.player.refs.push(s.$el.childNodes[0])},setPlayerDirection(s,t){var i;if(!((i=this.player.refs[t])!=null&&i.offsetLeft))return-1;const e=s<this.player.refs[t].offsetLeft;return e==this.player.isLeftWard[t]?-1:(this.player.isLeftWard[t]=e,e)},getPlayerPos(s){var l,a;if(v.playerPos[s])return v.playerPos[s];const t=this.player.refs[s];if(!t)return console.log("reference error!"),[void 0,void 0];let e=(l=t.getClientRects()[0])==null?void 0:l.left,i=(a=t.getClientRects()[0])==null?void 0:a.top;return e!==void 0&&i!==void 0&&(v.playerPos[s]=[e,i]),[e,i]},getReceptorId(s){const t=this.player.num;let e=[];for(let o=0;o<t;o++)o!==s&&e.push(o);if(this.trainingMode){const o=Math.floor(Math.random()*e.length);return e[o]}const i=this.topPlayerIdx===0&&this.topPlayerLimit!==null&&this.score.playerCounts[0]>=this.topPlayerLimit,l=this.score.throwCounts+1,a=Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0;if(!this.trainingMode&&a&&console.log(`[DEBUG] 传球 ${this.score.throwCounts} -> ${l}, 计划: [${this.topPlayerSchedule.join(",")}], 玩家0已接球: ${this.score.playerCounts[0]}/${this.topPlayerLimit}`),i)e=e.filter(o=>o!==0),console.log(`[DEBUG] 玩家0已达上限 ${this.topPlayerLimit}，排除玩家0`);else if(a)if(this.topPlayerSchedule[0]===l){if(s===0)console.log(`[DEBUG] 计划轮次 ${l} 球已在玩家0手中，跳过计划项`),this.topPlayerSchedule.shift(),e=e.filter(o=>o!==0);else if(e.includes(0))return console.log(`[DEBUG] 命中计划轮次 ${l}，强制传给玩家0`),0}else e=e.filter(o=>o!==0);if(e.length===0)for(let o=0;o<t;o++)o!==s&&e.push(o);const n=Math.floor(Math.random()*e.length);return e[n]},applyAIIdentityForThree(){Number(this.player.num)===3&&(!this.trainingMode&&this.aiPresetNamesEnabled?(this.player.name[1]="王佳琪",this.player.name[2]="刘明宇"):(this.player.name[1]="player1",this.player.name[2]="player2"))},getBallDx(s){let t=S;return this.player.isLeftWard[s]&&(t=0),t},onThrowBall(s){this.ball.owner==0&&this.throwBall(s)},async aiThrowBall(){if(this.gameOver)return;const s=this.getReceptorId(this.ball.owner);let t,e;this.trainingMode?(t=le,e=ie):(t=se,e=re);const i=t+Math.floor(Math.random()*(e-t+1));await _.sleep(i),!this.gameOver&&this.throwBall(s)},throwBall(s=0,t=.5){if(this.gameOver)return"game over";if(this.ball.moveDur=t,s==this.ball.owner)return"don't need to move the ball";if(this.setBallPos(s),this.ball.owner=s,this.scoreCounter(s),this.gameOver)return"game over";this.ball.owner>0&&this.aiThrowBall()},setBallPos(s){const t=this.getBallDx(s),[e,i]=this.getPlayerPos(s);if(!e||!i)return;const l=(e+t)/(window.innerWidth/100),a=(i-te)/$;this.ball.pos=[l,a]},resetBallPos(){this.ball.pos=[50-32/2/(window.innerWidth/100),(window.innerHeight-32)/$/2]},updateBallPosOnResize(){this.ball.moveDur=0,this.ball.owner||this.resetBallPos(),this.setBallPos(this.ball.owner)},shiftBallPos(s,t){this.ball.moveDur=t,this.ball.pos[0]+=s/(window.innerWidth/100)},initTopPlayerLimit(){var s;try{this.topPlayerIdx=0,console.log(`[DEBUG] initTopPlayerLimit 开始，URL: ${window.location.href}`);const t=new URLSearchParams(window.location.search||""),e=y=>{const d=["cfg","k","limit"];let r=null;for(const w of d){const g=y.get?y.get(w):y[w];if(g!=null){r=g;break}}if(console.log(`[DEBUG] getLimitFromParams 解析结果: val=${r}`),r===null)return NaN;const u=String(r).toLowerCase();if(u==="a"||u==="alpha")return 3;if(u==="b"||u==="beta")return 10;const p=Number(u);return Number.isNaN(p)?NaN:p===3||p===10?p:NaN},i=e(t),l=((s=this.$route)==null?void 0:s.query)||{},a=e({get:y=>l[y]});console.log(`[DEBUG] searchLimit=${i}, qLimit=${a}`);let n;const o=/(^|\?|&)\s*cfg=b(\b|&|$)/i.test(window.location.search||"");console.log(`[DEBUG] hasCfgB=${o}`),o?n=10:!Number.isNaN(i)&&i>0?n=i:!Number.isNaN(a)&&a>0?n=a:n=10,console.log(`[DEBUG] 最终解析 limit=${n}`),this.topPlayerLimit=o?10:n===3||n===10?n:10,console.log(`[DEBUG] 设置 topPlayerLimit=${this.topPlayerLimit}`);const c={3:"https://www.wjx.cn/vm/w3u3XJs.aspx",10:"https://www.wjx.cn/vm/OPiCEuk.aspx"};this.surveyUrl=c[this.topPlayerLimit]||""}catch(t){console.warn("initTopPlayerLimit failed",t),this.topPlayerIdx=0,this.topPlayerLimit=10}finally{this.topPlayerSchedule=this.buildEvenSchedule(this.totalPassLimit,this.topPlayerLimit),console.log(`[DEBUG] 生成计划：总传球${this.totalPassLimit}，玩家0目标${this.topPlayerLimit}次，计划时机: [${this.topPlayerSchedule.join(",")}]`)}},buildEvenSchedule(s,t){try{if(!t||t<=0)return[];const e=t,i=[];for(let r=1;r<=e;r++)i.push(r*(s+1)/(e+1));const l=s/(e+1),a=Math.max(1,Math.floor(l*.35));let n=i.map(r=>{const u=Math.floor((Math.random()*2-1)*a),p=Math.round(r+u);return Math.min(Math.max(p,1),s)});n.sort((r,u)=>r-u);const o=Math.max(1,Math.floor(l*.4)),c=[];for(let r=0;r<e;r++){let u=n[r];if(r===0){const p=s-(e-1)*o;u=Math.min(u,Math.max(1,p))}else u=Math.max(u,c[r-1]+o);c.push(u)}let y=c[e-1]-s;if(y>0)for(let r=e-1;r>=0&&y>0;r--){const u=r>0?c[r-1]:0,p=r===0?1:u+o,w=Math.max(0,c[r]-p);if(w>0){const g=Math.min(w,y);c[r]-=g,y-=g}}for(let r=0;r<e;r++)r===0?c[r]=Math.min(Math.max(c[r],1),s-(e-1)*o):c[r]=Math.min(Math.max(c[r],c[r-1]+o),s-(e-1-r)*o);const d=c.map(r=>Math.round(r));for(let r=1;r<d.length;r++)d[r]===d[r-1]+1&&(d[r]=d[r]+1,d[r]>s&&(d[r]=s));return d}catch(e){return console.warn("buildEvenSchedule failed",e),[]}},onPlayerLoaded(s){s===0&&(this.showIntro||(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0))},async startGame(){if(this.showIntro=!1,this.trainingMode)this.showLoading=!1;else{const e=Date.now(),i=y=>{const p=(y*1664525+1013904223)%4294967296;return{r:p/4294967296,seed:p}};let l=i(e);this.waitSeconds=15+Math.floor(l.r*(60-15+1));const a=Math.min(5,this.waitSeconds-15);let n=i(l.seed);const o=Math.floor(n.r*(a+1)),c=this.waitSeconds-o;this.effectiveWait=c,this.showAlmostStart=!1,this.loadingElapsed=0,this.aiPresetNamesEnabled=!1,this.applyAIIdentityForThree(),this.loadingRemaining=c,this.showLoading=!0,this.loadingTimer=setInterval(()=>{this.loadingRemaining>0?(this.loadingRemaining--,this.loadingElapsed++,this.loadingRemaining===5&&(this.aiPresetNamesEnabled=!0,this.applyAIIdentityForThree()),this.showAlmostStart=this.loadingRemaining<=5&&this.loadingRemaining>0):(clearInterval(this.loadingTimer),this.loadingTimer=null)},1e3),await _.sleep(c*1e3),this.showLoading=!1,this.loadingTimer&&(clearInterval(this.loadingTimer),this.loadingTimer=null),this.loadingRemaining=0,this.loadingElapsed=0,this.showAlmostStart=!1,this.effectiveWait=0}this.player.refs[0]?(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0):this.$nextTick(()=>{this.gameOver||(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0)})},restartGame(){this.loadingTimer&&(clearInterval(this.loadingTimer),this.loadingTimer=null),this.loadingRemaining=0,this.loadingElapsed=0,this.showAlmostStart=!1,this.effectiveWait=0,this.gameOver=!1,this.endMsg="",this.score.throwCounts=0;for(let s=0;s<this.score.playerCounts.length;s++)this.score.playerCounts[s]=0;this.ball.moveDur=0,this.ball.owner=void 0,this.resetBallPos(),v.playerPos={},this.lastPlayer0Throw=null,this.initTopPlayerLimit()}},mounted(){try{["playerName","playerHue","playerGray","playerNum","isSave","cb_topPlayerLimit"].forEach(t=>localStorage.removeItem(t))}catch{}this.loadConfigs(),this.watchWindowResize(),this.$nextTick(()=>{var i,l,a,n,o,c,y,d,r,u,p,w,g,C;this.initTopPlayerLimit();const s=((l=(i=this.$route)==null?void 0:i.query)==null?void 0:l.mode)==="training";if(console.log(`[DEBUG] 路由参数 mode=${(n=(a=this.$route)==null?void 0:a.query)==null?void 0:n.mode}, isTrainingMode=${s}`),s)this.trainingMode=!0,console.log("[DEBUG] 设置为训练模式");else{const B=new URLSearchParams(window.location.search||""),x=B.get("cfg")!==null||B.get("k")!==null||B.get("limit")!==null||(((c=(o=this.$route)==null?void 0:o.query)==null?void 0:c.cfg)??null)!==null||(((d=(y=this.$route)==null?void 0:y.query)==null?void 0:d.k)??null)!==null||(((u=(r=this.$route)==null?void 0:r.query)==null?void 0:u.limit)??null)!==null;this.trainingMode=!1,console.log(`[DEBUG] 设置为正式模式, hasFormalCfg=${x}`)}const t=Number((w=(p=this.$route)==null?void 0:p.query)==null?void 0:w.wait),e=Number((C=(g=this.$store)==null?void 0:g.getters)==null?void 0:C.waitSeconds);!Number.isNaN(t)&&t>0?this.waitSeconds=t:!Number.isNaN(e)&&e>0&&(this.waitSeconds=e),this.aiPresetNamesEnabled=!1,this.applyAIIdentityForThree()})},beforeUpdate(){this.player.refs=[]}},oe={class:"game-page"},ne={class:"main-page"},he={key:0,class:"end-overlay"},ce={class:"end-modal"},ue={class:"intro-text"},de={key:0},ye={key:1},me={key:1,class:"end-overlay"},pe={class:"end-modal"},fe={key:0},ge={key:1},we={class:"loading-wrap"},_e={key:0,class:"loading-spinner"},ve={key:1,class:"ready-indicator sk-fading-circle","aria-label":"玩家已就绪"},Pe={class:"loading-text"},Ne={key:0},Le={key:1},be={key:2,class:"end-overlay"},Be={class:"end-modal"},Me={class:"survey-placeholder"},Se=["href"],ke={key:1},Ce={id:"menu-btn"};function $e(s,t,e,i,l,a){const n=P("Player"),o=P("Ball"),c=P("ScoreBoard"),y=P("NavButton");return m(),f("div",oe,[t[7]||(t[7]=h("h1",null,"CyberBall",-1)),h("div",ne,[h("div",{class:"players-wrap",onMousemove:t[0]||(t[0]=(...d)=>a.onPlayerTurn&&a.onPlayerTurn(...d))},[(m(!0),f(D,null,T(a.gridArea,(d,r)=>(m(),U(n,{key:r,ref_for:!0,ref:a.setPlayerRef,style:k(d),playerStyle:a.playerStyle[r],playerName:l.player.name[r],isLeftWard:l.player.isLeftWard[r],title:`分数：${l.score.playerCounts[r]}`,onMoveBall:u=>a.onThrowBall(r),onPlayerLoaded:u=>a.onPlayerLoaded(r)},null,8,["style","playerStyle","playerName","isLeftWard","title","onMoveBall","onPlayerLoaded"]))),128))],32)]),N(o,{posx:l.ball.pos[0],posy:l.ball.pos[1],moveDur:l.ball.moveDur},null,8,["posx","posy","moveDur"]),N(c,{throwNum:l.score.throwCounts,score:a.scoreRank},null,8,["throwNum","score"]),l.showIntro?(m(),f("div",he,[h("div",ce,[t[4]||(t[4]=h("h2",null,"玩法说明",-1)),h("div",ue,[l.trainingMode?(m(),f("p",ye,"现在进入练习环节，在屏幕上你会看到三个人物进行传球游戏 ")):(m(),f("p",de,"现在进入到正式的实验环节，在屏幕上你会看到三个人物进行传球游戏 ")),t[2]||(t[2]=h("ul",null,[h("li",null,"屏幕底部的人物是你自己。"),h("li",null,"另外两个人物是在其它房间进行实验的另外两个人"),h("li",null,"你们之间会互相进行传球，每一次你可以选择将球传给其中一人 ")],-1)),t[3]||(t[3]=h("p",null,"准备好了请点击“进入游戏” ",-1))]),h("button",{onClick:t[1]||(t[1]=(...d)=>a.startGame&&a.startGame(...d))},"进入游戏")])])):M("",!0),l.showLoading&&!l.trainingMode?(m(),f("div",me,[h("div",pe,[l.showAlmostStart?(m(),f("h2",ge,"匹配就绪，游戏房间资源加载中")):(m(),f("h2",fe,"正在等待其他玩家准备中……")),h("div",we,[l.showAlmostStart?(m(),f("div",ve,[...t[5]||(t[5]=[G('<span class="sk-circle1 sk-circle"></span><span class="sk-circle2 sk-circle"></span><span class="sk-circle3 sk-circle"></span><span class="sk-circle4 sk-circle"></span><span class="sk-circle5 sk-circle"></span><span class="sk-circle6 sk-circle"></span><span class="sk-circle7 sk-circle"></span><span class="sk-circle8 sk-circle"></span><span class="sk-circle9 sk-circle"></span><span class="sk-circle10 sk-circle"></span><span class="sk-circle11 sk-circle"></span><span class="sk-circle12 sk-circle"></span>',12)])])):(m(),f("div",_e)),h("div",Pe,[l.showAlmostStart?(m(),f("span",Ne,"玩家已就绪，正在进入…")):(m(),f("span",Le,"请稍候，游戏即将开始…"))])])])])):M("",!0),l.gameOver?(m(),f("div",be,[h("div",Be,[t[6]||(t[6]=h("h2",null,"游戏结束",-1)),h("p",null,L(l.endMsg),1),h("div",Me,[l.surveyUrl?(m(),f("a",{key:0,href:l.surveyUrl,target:"_blank",rel:"noopener"},"参与问卷",8,Se)):(m(),f("span",ke,"问卷链接占位"))]),N(y,{destination:"/",text:"返回"})])])):M("",!0),h("div",Ce,[N(y,{destination:"/",text:"返回"})])])}const xe=b(ae,[["render",$e]]);export{xe as default};
