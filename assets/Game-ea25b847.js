import{P as A}from"./PlayerImg-99010edd.js";import{_ as b,r as _,o as d,c as p,a as P,n as I,b as k,d as u,t as N,e as D,F as C,f as T,N as R,g as L,h as W,i as $}from"./index-e10883b4.js";const E={name:"Player",components:{PlayerImg:A},props:{isLeftWard:Boolean,playerStyle:String,playerName:String},emits:["moveBall","playerLoaded"]};function O(t,e,s,i,r,l){const h=_("PlayerImg");return d(),p("div",null,[P(h,{class:I(s.isLeftWard?"player-leftWard":"player-rightWard"),style:k(s.playerStyle),onClick:e[0]||(e[0]=n=>t.$emit("moveBall")),onLoad:e[1]||(e[1]=n=>t.$emit("playerLoaded"))},null,8,["class","style"]),u("p",null,N(s.playerName),1)])}const q=b(E,[["render",O]]);const G={name:"Ball",props:{posx:Number,posy:Number,moveDur:Number},computed:{ballStyle(){return`transform:translate(${this.posx}vw, ${this.posy}rem); transition: ${this.moveDur}s ease-out`}}};function z(t,e,s,i,r,l){return d(),p("img",{class:"ball",src:D,style:k(l.ballStyle)},null,4)}const F=b(G,[["render",z]]);const U={props:{throwNum:Number,score:Array}},X={class:"score-board"},V={class:"score-row"};function Y(t,e,s,i,r,l){return d(),p("div",X,[u("p",null,"目前球数："+N(s.throwNum),1),e[0]||(e[0]=u("p",null,"排行榜：",-1)),u("ol",null,[(d(),p(C,null,T(3,h=>u("li",{key:h},[u("div",V,[u("div",null,N(s.score[h-1].player),1),u("div",null,N(s.score[h-1].value),1)])])),64))])])}const H=b(U,[["render",Y]]),j={rect:{mode1:["3 / 2 / auto / 4","2 / 1","2 / 4","1 / 2 / auto / 4","3 / 3","1 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"],mode2:["3 / 2","2 / 1 / 4","2 / 4 / 4","1 / 2","3 / 3 / auto / 5","1 / 4 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"]},modeMap:{3:[],4:[],5:[0],6:[0,3],7:[0,1,2,5],8:[0,1,2,3],9:[1,2,3,4]}},J=t=>{const e=t.map(s=>s*Math.random());return e.indexOf(Math.max(...e))},K=t=>{const e=[...t],s=[...t];e.sort((h,n)=>n-h);const i=s.indexOf(e[0]);s[i]=void 0;const r=s.indexOf(e[1]);s[r]=void 0;const l=s.indexOf(e[2]);return s[l]=void 0,[i,r,l]},Q=t=>new Promise(e=>{setTimeout(e,t)}),v={playerLayout:j,getRandomIdx:J,getTopIdx:K,sleep:Q};const B=16,S=67,Z=5,x=1e3,ee=5e3,w={playerPos:{}},te={components:{ScoreBoard:H,NavButton:R,Player:q,Ball:F},data(){return{score:{throwCounts:0,playerCounts:[0,0,0,0,0,0,0,0,0]},gameOver:!1,totalPassLimit:30,topPlayerIdx:null,topPlayerLimit:null,topPlayerSchedule:[],lastPlayer0Throw:null,endMsg:"",trainingMode:!1,showIntro:!0,showLoading:!1,waitSeconds:6,surveyUrl:"",player:{num:3,numInput:3,turnDur:0,filter:"sepia(1) saturate(20)",hue:180,gray:0,name:["player","player1","player2","player3","player4","player5","player6","player7","player8"],isLeftWard:[!1,!1,!0,!1,!0,!0,!1,!0,!1,!0],refs:[]},ball:{pos:[-10,-10],moveDur:0,owner:void 0},loadingRemaining:0,loadingElapsed:0,loadingTimer:null,showAlmostStart:!1,effectiveWait:0,aiPresetNamesEnabled:!1}},computed:{scoreRank(){const[t,e,s]=v.getTopIdx(this.score.playerCounts);return[{player:this.player.name[t],value:this.score.playerCounts[t]},{player:this.player.name[e],value:this.score.playerCounts[e]},{player:this.player.name[s],value:this.score.playerCounts[s]}]},playerStyle(){const t=(s,i,r)=>`filter: ${this.player.filter} hue-rotate(${s}deg) grayscale(${i}%); transition:${r}s linear`,e=[t(this.player.hue,this.player.gray,this.player.turnDur)];for(let s=1;s<this.player.num;s++)Number(this.player.num)===3&&s===1?e.push("filter: sepia(1) saturate(12) hue-rotate(190deg) brightness(0.95) contrast(1.15) grayscale(0%); transition:0s linear"):Number(this.player.num)===3&&s===2?e.push("filter: sepia(1) saturate(12) hue-rotate(330deg) brightness(1.0) contrast(1.10) grayscale(0%); transition:0s linear"):e.push(t(Math.random()*360,Math.random()*100,0));return e},gridArea(){const t=s=>v.playerLayout.modeMap[this.player.num].includes(s)?`grid-area: ${v.playerLayout.rect.mode2[s]}`:`grid-area: ${v.playerLayout.rect.mode1[s]}`,e=[];for(let s=0;s<this.player.num;s++)e.push(t(s));return e}},methods:{loadConfigs(){var n,o,y,a,c,m,f,g,M;const t=((n=this.$route)==null?void 0:n.query)||{},e=t.name?String(t.name):null,s=t.hue!==void 0?Number(t.hue):null,i=t.gray!==void 0?Number(t.gray):null,r=t.num!==void 0?Number(t.num):null;this.player.name[0]=e&&e.length>0?e:((y=(o=this.$store)==null?void 0:o.getters)==null?void 0:y.playerName)||this.player.name[0],!Number.isNaN(s)&&s!==null?this.player.hue=s:this.player.hue=((c=(a=this.$store)==null?void 0:a.getters)==null?void 0:c.playerHue)||this.player.hue,!Number.isNaN(i)&&i!==null?this.player.gray=i:this.player.gray=((f=(m=this.$store)==null?void 0:m.getters)==null?void 0:f.playerGray)||this.player.gray;let l=Number((M=(g=this.$store)==null?void 0:g.getters)==null?void 0:M.playerNum),h=!Number.isNaN(r)&&r>=3&&r<=9?r:!Number.isNaN(l)&&l>=3&&l<=9?l:this.player.num;this.player.num=h,this.player.numInput=h},scoreCounter(t){if(this.gameOver)return;if(this.trainingMode){this.score.throwCounts++,this.score.playerCounts[t]++,t===0&&(Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0&&this.topPlayerSchedule[0]===this.score.throwCounts&&this.topPlayerSchedule.shift(),this.lastPlayer0Throw=this.score.throwCounts);return}this.score.throwCounts++,this.score.playerCounts[t]++,t===0&&(Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0&&this.topPlayerSchedule[0]===this.score.throwCounts&&this.topPlayerSchedule.shift(),this.lastPlayer0Throw=this.score.throwCounts),this.score.throwCounts>=this.totalPassLimit&&(this.gameOver=!0,this.ball.moveDur=0,this.endMsg=`总传球数：${this.score.throwCounts}/${this.totalPassLimit}；你的接球数：${this.score.playerCounts[0]}`)},watchWindowResize(){window.addEventListener("resize",()=>{w.playerPos={},this.updateBallPosOnResize()},!1)},onPlayerTurn(t){const e=t.clientX;for(const s of[0]){const i=this.setPlayerDirection(e,s);if(i===-1)break;if(this.ball.owner==s){const r=i?-S:S;this.shiftBallPos(r,this.player.turnDur)}}},setPlayerRef(t){t&&this.player.refs.push(t.$el.childNodes[0])},setPlayerDirection(t,e){var i;if(!((i=this.player.refs[e])!=null&&i.offsetLeft))return-1;const s=t<this.player.refs[e].offsetLeft;return s==this.player.isLeftWard[e]?-1:(this.player.isLeftWard[e]=s,s)},getPlayerPos(t){var r,l;if(w.playerPos[t])return w.playerPos[t];const e=this.player.refs[t];if(!e)return console.log("reference error!"),[void 0,void 0];let s=(r=e.getClientRects()[0])==null?void 0:r.left,i=(l=e.getClientRects()[0])==null?void 0:l.top;return s!==void 0&&i!==void 0&&(w.playerPos[t]=[s,i]),[s,i]},getReceptorId(t){const e=this.player.num;let s=[];for(let n=0;n<e;n++)n!==t&&s.push(n);if(this.trainingMode){const n=Math.floor(Math.random()*s.length);return s[n]}const i=this.topPlayerIdx===0&&this.topPlayerLimit!==null&&this.score.playerCounts[0]>=this.topPlayerLimit,r=this.score.throwCounts+1,l=Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0;if(i)s=s.filter(n=>n!==0);else if(l){if(t!==0&&s.includes(0)&&this.topPlayerSchedule[0]===r)return 0;s=s.filter(n=>n!==0)}if(s.length===0)for(let n=0;n<e;n++)n!==t&&s.push(n);const h=Math.floor(Math.random()*s.length);return s[h]},applyAIIdentityForThree(){Number(this.player.num)===3&&(!this.trainingMode&&this.aiPresetNamesEnabled?(this.player.name[1]="王佳琪",this.player.name[2]="刘明宇"):(this.player.name[1]="player1",this.player.name[2]="player2"))},getBallDx(t){let e=S;return this.player.isLeftWard[t]&&(e=0),e},onThrowBall(t){this.ball.owner==0&&this.throwBall(t)},async aiThrowBall(){if(this.gameOver)return;const t=this.getReceptorId(this.ball.owner),e=x+Math.floor(Math.random()*(ee-x+1));await v.sleep(e),!this.gameOver&&this.throwBall(t)},throwBall(t=0,e=.5){if(this.gameOver)return"game over";if(this.ball.moveDur=e,t==this.ball.owner)return"don't need to move the ball";if(this.setBallPos(t),this.ball.owner=t,this.scoreCounter(t),this.gameOver)return"game over";this.ball.owner>0&&this.aiThrowBall()},setBallPos(t){const e=this.getBallDx(t),[s,i]=this.getPlayerPos(t);if(!s||!i)return;const r=(s+e)/(window.innerWidth/100),l=(i-Z)/B;this.ball.pos=[r,l]},resetBallPos(){this.ball.pos=[50-32/2/(window.innerWidth/100),(window.innerHeight-32)/B/2]},updateBallPosOnResize(){this.ball.moveDur=0,this.ball.owner||this.resetBallPos(),this.setBallPos(this.ball.owner)},shiftBallPos(t,e){this.ball.moveDur=e,this.ball.pos[0]+=t/(window.innerWidth/100)},initTopPlayerLimit(){var t;try{this.topPlayerIdx=0;const e=new URLSearchParams(window.location.search||""),s=o=>{const y=["cfg","k","limit"];let a=null;for(const f of y){const g=o.get?o.get(f):o[f];if(g!=null){a=g;break}}if(a===null)return NaN;const c=String(a).toLowerCase();if(c==="a"||c==="alpha")return 3;if(c==="b"||c==="beta")return 10;const m=Number(c);return Number.isNaN(m)?NaN:m},i=s(e),r=((t=this.$route)==null?void 0:t.query)||{},l=s({get:o=>r[o]});let h;!Number.isNaN(i)&&i>0?h=i:!Number.isNaN(l)&&l>0?h=l:h=10,this.topPlayerLimit=h===3||h===10?h:10;const n={3:"https://www.wjx.cn/vm/w3u3XJs.aspx",10:"https://www.wjx.cn/vm/OPiCEuk.aspx"};this.surveyUrl=n[this.topPlayerLimit]||""}catch(e){console.warn("initTopPlayerLimit failed",e),this.topPlayerIdx=0,this.topPlayerLimit=10}finally{this.topPlayerSchedule=this.buildEvenSchedule(this.totalPassLimit,this.topPlayerLimit)}},buildEvenSchedule(t,e){try{if(!e||e<=0)return[];const s=e,i=[];for(let a=1;a<=s;a++)i.push(a*(t+1)/(s+1));const r=t/(s+1),l=Math.max(1,Math.floor(r*.35));let h=i.map(a=>{const c=Math.floor((Math.random()*2-1)*l),m=Math.round(a+c);return Math.min(Math.max(m,1),t)});h.sort((a,c)=>a-c);const n=Math.max(1,Math.floor(r*.4)),o=[];for(let a=0;a<s;a++){let c=h[a];if(a===0){const m=t-(s-1)*n;c=Math.min(c,Math.max(1,m))}else c=Math.max(c,o[a-1]+n);o.push(c)}let y=o[s-1]-t;if(y>0)for(let a=s-1;a>=0&&y>0;a--){const c=a>0?o[a-1]:0,m=a===0?1:c+n,f=Math.max(0,o[a]-m);if(f>0){const g=Math.min(f,y);o[a]-=g,y-=g}}for(let a=0;a<s;a++)a===0?o[a]=Math.min(Math.max(o[a],1),t-(s-1)*n):o[a]=Math.min(Math.max(o[a],o[a-1]+n),t-(s-1-a)*n);return o.map(a=>Math.round(a))}catch(s){return console.warn("buildEvenSchedule failed",s),[]}},onPlayerLoaded(t){t===0&&(this.showIntro||(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0))},async startGame(){if(this.showIntro=!1,this.trainingMode)this.showLoading=!1;else{const s=Date.now(),i=y=>{const f=(y*1664525+1013904223)%4294967296;return{r:f/4294967296,seed:f}};let r=i(s);this.waitSeconds=15+Math.floor(r.r*(60-15+1));const l=Math.min(5,this.waitSeconds-15);let h=i(r.seed);const n=Math.floor(h.r*(l+1)),o=this.waitSeconds-n;this.effectiveWait=o,this.showAlmostStart=!1,this.loadingElapsed=0,this.aiPresetNamesEnabled=!1,this.applyAIIdentityForThree(),this.loadingRemaining=o,this.showLoading=!0,this.loadingTimer=setInterval(()=>{this.loadingRemaining>0?(this.loadingRemaining--,this.loadingElapsed++,this.loadingRemaining===5&&(this.aiPresetNamesEnabled=!0,this.applyAIIdentityForThree()),this.showAlmostStart=this.loadingRemaining<=5&&this.loadingRemaining>0):(clearInterval(this.loadingTimer),this.loadingTimer=null)},1e3),await v.sleep(o*1e3),this.showLoading=!1,this.loadingTimer&&(clearInterval(this.loadingTimer),this.loadingTimer=null),this.loadingRemaining=0,this.loadingElapsed=0,this.showAlmostStart=!1,this.effectiveWait=0}this.player.refs[0]?(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0):this.$nextTick(()=>{this.gameOver||(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0)})},restartGame(){this.loadingTimer&&(clearInterval(this.loadingTimer),this.loadingTimer=null),this.loadingRemaining=0,this.loadingElapsed=0,this.showAlmostStart=!1,this.effectiveWait=0,this.gameOver=!1,this.endMsg="",this.score.throwCounts=0;for(let t=0;t<this.score.playerCounts.length;t++)this.score.playerCounts[t]=0;this.ball.moveDur=0,this.ball.owner=void 0,this.resetBallPos(),w.playerPos={},this.lastPlayer0Throw=null,this.initTopPlayerLimit()}},mounted(){try{["playerName","playerHue","playerGray","playerNum","isSave","cb_topPlayerLimit"].forEach(e=>localStorage.removeItem(e))}catch{}this.loadConfigs(),this.watchWindowResize(),this.$nextTick(()=>{var s,i,r,l,h,n,o,y;this.initTopPlayerLimit(),this.trainingMode=((i=(s=this.$route)==null?void 0:s.query)==null?void 0:i.mode)==="training"||((l=(r=this.$store)==null?void 0:r.getters)==null?void 0:l.trainingMode)===!0;const t=Number((n=(h=this.$route)==null?void 0:h.query)==null?void 0:n.wait),e=Number((y=(o=this.$store)==null?void 0:o.getters)==null?void 0:y.waitSeconds);!Number.isNaN(t)&&t>0?this.waitSeconds=t:!Number.isNaN(e)&&e>0&&(this.waitSeconds=e),this.aiPresetNamesEnabled=!1,this.applyAIIdentityForThree()})},beforeUpdate(){this.player.refs=[]}},se={class:"game-page"},re={class:"main-page"},ae={key:0,class:"end-overlay"},ie={class:"end-modal"},le={class:"intro-text"},ne={key:0},oe={key:1},he={key:1,class:"end-overlay"},ce={class:"end-modal"},ue={key:0},de={key:1},pe={class:"loading-wrap"},ye={key:0,class:"loading-spinner"},me={key:1,class:"ready-indicator sk-fading-circle","aria-label":"玩家已就绪"},fe={class:"loading-text"},ge={key:0},ve={key:1},we={key:2,class:"end-overlay"},_e={class:"end-modal"},Pe={class:"survey-placeholder"},Ne=["href"],be={key:1},Le={id:"menu-btn"};function Se(t,e,s,i,r,l){const h=_("Player"),n=_("Ball"),o=_("ScoreBoard"),y=_("NavButton");return d(),p("div",se,[e[7]||(e[7]=u("h1",null,"CyberBall",-1)),u("div",re,[u("div",{class:"players-wrap",onMousemove:e[0]||(e[0]=(...a)=>l.onPlayerTurn&&l.onPlayerTurn(...a))},[(d(!0),p(C,null,T(l.gridArea,(a,c)=>(d(),$(h,{key:c,ref_for:!0,ref:l.setPlayerRef,style:k(a),playerStyle:l.playerStyle[c],playerName:r.player.name[c],isLeftWard:r.player.isLeftWard[c],title:`分数：${r.score.playerCounts[c]}`,onMoveBall:m=>l.onThrowBall(c),onPlayerLoaded:m=>l.onPlayerLoaded(c)},null,8,["style","playerStyle","playerName","isLeftWard","title","onMoveBall","onPlayerLoaded"]))),128))],32)]),P(n,{posx:r.ball.pos[0],posy:r.ball.pos[1],moveDur:r.ball.moveDur},null,8,["posx","posy","moveDur"]),P(o,{throwNum:r.score.throwCounts,score:l.scoreRank},null,8,["throwNum","score"]),r.showIntro?(d(),p("div",ae,[u("div",ie,[e[4]||(e[4]=u("h2",null,"玩法说明",-1)),u("div",le,[r.trainingMode?(d(),p("p",oe,"现在进入练习环节，在屏幕上你会看到三个人物进行传球游戏 ")):(d(),p("p",ne,"现在进入到正式的实验环节，在屏幕上你会看到三个人物进行传球游戏 ")),e[2]||(e[2]=u("ul",null,[u("li",null,"屏幕底部的人物是你自己。"),u("li",null,"另外两个人物是在其它房间进行实验的另外两个人"),u("li",null,"你们之间会互相进行传球，每一次你可以选择将球传给其中一人 ")],-1)),e[3]||(e[3]=u("p",null,"准备好了请点击“进入游戏” ",-1))]),u("button",{onClick:e[1]||(e[1]=(...a)=>l.startGame&&l.startGame(...a))},"进入游戏")])])):L("",!0),r.showLoading&&!r.trainingMode?(d(),p("div",he,[u("div",ce,[r.showAlmostStart?(d(),p("h2",de,"匹配就绪，游戏房间资源加载中")):(d(),p("h2",ue,"正在等待其他玩家准备中……")),u("div",pe,[r.showAlmostStart?(d(),p("div",me,[...e[5]||(e[5]=[W('<span class="sk-circle1 sk-circle"></span><span class="sk-circle2 sk-circle"></span><span class="sk-circle3 sk-circle"></span><span class="sk-circle4 sk-circle"></span><span class="sk-circle5 sk-circle"></span><span class="sk-circle6 sk-circle"></span><span class="sk-circle7 sk-circle"></span><span class="sk-circle8 sk-circle"></span><span class="sk-circle9 sk-circle"></span><span class="sk-circle10 sk-circle"></span><span class="sk-circle11 sk-circle"></span><span class="sk-circle12 sk-circle"></span>',12)])])):(d(),p("div",ye)),u("div",fe,[r.showAlmostStart?(d(),p("span",ge,"玩家已就绪，正在进入…")):(d(),p("span",ve,"请稍候，游戏即将开始…"))])])])])):L("",!0),r.gameOver?(d(),p("div",we,[u("div",_e,[e[6]||(e[6]=u("h2",null,"游戏结束",-1)),u("p",null,N(r.endMsg),1),u("div",Pe,[r.surveyUrl?(d(),p("a",{key:0,href:r.surveyUrl,target:"_blank",rel:"noopener"},"参与问卷",8,Ne)):(d(),p("span",be,"问卷链接占位"))]),P(y,{destination:"/",text:"返回"})])])):L("",!0),u("div",Le,[P(y,{destination:"/",text:"返回"})])])}const Be=b(te,[["render",Se]]);export{Be as default};
