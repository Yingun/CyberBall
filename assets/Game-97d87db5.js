import{P as $}from"./PlayerImg-7b373c6c.js";import{_ as g,r as d,o as i,c as u,a as m,n as D,b as P,d as o,t as f,e as M,F as B,f as b,N as T,g as x,h as S}from"./index-d0b4f955.js";const W={name:"Player",components:{PlayerImg:$},props:{isLeftWard:Boolean,playerStyle:String,playerName:String},emits:["moveBall","playerLoaded"]};function R(e,r,t,l,a,s){const n=d("PlayerImg");return i(),u("div",null,[m(n,{class:D(t.isLeftWard?"player-leftWard":"player-rightWard"),style:P(t.playerStyle),onClick:r[0]||(r[0]=y=>e.$emit("moveBall")),onLoad:r[1]||(r[1]=y=>e.$emit("playerLoaded"))},null,8,["class","style"]),o("p",null,f(t.playerName),1)])}const k=g(W,[["render",R]]);const O={name:"Ball",props:{posx:Number,posy:Number,moveDur:Number},computed:{ballStyle(){return`transform:translate(${this.posx}vw, ${this.posy}rem); transition: ${this.moveDur}s ease-out`}}};function I(e,r,t,l,a,s){return i(),u("img",{class:"ball",src:M,style:P(s.ballStyle)},null,4)}const A=g(O,[["render",I]]);const z={props:{throwNum:Number,score:Array}},G={class:"score-board"},U={class:"score-row"};function F(e,r,t,l,a,s){return i(),u("div",G,[o("p",null,"目前球数："+f(t.throwNum),1),r[0]||(r[0]=o("p",null,"排行榜：",-1)),o("ol",null,[(i(),u(B,null,b(3,n=>o("li",{key:n},[o("div",U,[o("div",null,f(t.score[n-1].player),1),o("div",null,f(t.score[n-1].value),1)])])),64))])])}const V=g(z,[["render",F]]),X={rect:{mode1:["3 / 2 / auto / 4","2 / 1","2 / 4","1 / 2 / auto / 4","3 / 3","1 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"],mode2:["3 / 2","2 / 1 / 4","2 / 4 / 4","1 / 2","3 / 3 / auto / 5","1 / 4 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"]},modeMap:{3:[],4:[],5:[0],6:[0,3],7:[0,1,2,5],8:[0,1,2,3],9:[1,2,3,4]}},Y=e=>{const r=e.map(t=>t*Math.random());return r.indexOf(Math.max(...r))},E=e=>{const r=[...e],t=[...e];r.sort((n,y)=>y-n);const l=t.indexOf(r[0]);t[l]=void 0;const a=t.indexOf(r[1]);t[a]=void 0;const s=t.indexOf(r[2]);return t[s]=void 0,[l,a,s]},H=e=>new Promise(r=>{setTimeout(r,e)}),p={playerLayout:X,getRandomIdx:Y,getTopIdx:E,sleep:H};const L=16,v=67,q=5,j=2e3,c={playerPos:{}},J={components:{ScoreBoard:V,NavButton:T,Player:k,Ball:A},data(){return{score:{throwCounts:0,playerCounts:[0,0,0,0,0,0,0,0,0]},gameOver:!1,totalPassLimit:30,topPlayerIdx:null,topPlayerLimit:null,endMsg:"",trainingMode:!1,surveyUrl:"https://www.baidu.com",player:{num:4,numInput:4,turnDur:0,filter:"sepia(1) saturate(20)",hue:180,gray:0,name:["player","player1","player2","player3","player4","player5","player6","player7","player8"],isLeftWard:[!1,!1,!0,!1,!0,!0,!1,!0,!1,!0],refs:[]},ball:{pos:[-10,-10],moveDur:0,owner:void 0}}},computed:{scoreRank(){const[e,r,t]=p.getTopIdx(this.score.playerCounts);return[{player:this.player.name[e],value:this.score.playerCounts[e]},{player:this.player.name[r],value:this.score.playerCounts[r]},{player:this.player.name[t],value:this.score.playerCounts[t]}]},playerStyle(){const e=(t,l,a)=>`filter: ${this.player.filter} hue-rotate(${t}deg) grayscale(${l}%); transition:${a}s linear`,r=[e(this.player.hue,this.player.gray,this.player.turnDur)];for(let t=1;t<this.player.num;t++)Number(this.player.num)===3&&t===1?r.push("filter: sepia(1) saturate(12) hue-rotate(190deg) brightness(0.95) contrast(1.15) grayscale(0%); transition:0s linear"):Number(this.player.num)===3&&t===2?r.push("filter: sepia(1) saturate(12) hue-rotate(330deg) brightness(1.0) contrast(1.10) grayscale(0%); transition:0s linear"):r.push(e(Math.random()*360,Math.random()*100,0));return r},gridArea(){const e=t=>p.playerLayout.modeMap[this.player.num].includes(t)?`grid-area: ${p.playerLayout.rect.mode2[t]}`:`grid-area: ${p.playerLayout.rect.mode1[t]}`,r=[];for(let t=0;t<this.player.num;t++)r.push(e(t));return r}},methods:{loadConfigs(){this.player.name[0]=this.$store.getters.playerName||this.player.name[0],this.player.hue=this.$store.getters.playerHue||this.player.hue,this.player.gray=this.$store.getters.playerGray||this.player.gray,this.player.num=Number(this.$store.getters.playerNum)||this.player.num},scoreCounter(e){if(this.gameOver)return;if(this.trainingMode){this.score.throwCounts++,this.score.playerCounts[e]++;return}this.score.throwCounts++,this.score.playerCounts[e]++,this.score.throwCounts>=this.totalPassLimit&&(this.gameOver=!0,this.ball.moveDur=0,this.endMsg=`总传球数：${this.score.throwCounts}/${this.totalPassLimit}；你的接球数：${this.score.playerCounts[0]}`)},watchWindowResize(){window.addEventListener("resize",()=>{c.playerPos={},this.updateBallPosOnResize()},!1)},onPlayerTurn(e){const r=e.clientX;for(const t of[0]){const l=this.setPlayerDirection(r,t);if(l===-1)break;if(this.ball.owner==t){const a=l?-v:v;this.shiftBallPos(a,this.player.turnDur)}}},setPlayerRef(e){e&&this.player.refs.push(e.$el.childNodes[0])},setPlayerDirection(e,r){var l;if(!((l=this.player.refs[r])!=null&&l.offsetLeft))return-1;const t=e<this.player.refs[r].offsetLeft;return t==this.player.isLeftWard[r]?-1:(this.player.isLeftWard[r]=t,t)},getPlayerPos(e){var a,s;if(c.playerPos[e])return c.playerPos[e];const r=this.player.refs[e];if(!r)return console.log("reference error!"),[void 0,void 0];let t=(a=r.getClientRects()[0])==null?void 0:a.left,l=(s=r.getClientRects()[0])==null?void 0:s.top;return t!==void 0&&l!==void 0&&(c.playerPos[e]=[t,l]),[t,l]},getReceptorId(e){const r=this.player.num;let t=[];for(let s=0;s<r;s++)s!==e&&t.push(s);if(this.trainingMode){const s=Math.floor(Math.random()*t.length);return t[s]}if(this.topPlayerIdx===0&&this.topPlayerLimit!==null&&this.score.playerCounts[0]>=this.topPlayerLimit)t=t.filter(s=>s!==0);else{const s=this.totalPassLimit-this.score.throwCounts,n=this.topPlayerLimit-this.score.playerCounts[0];if(s<=n&&t.includes(0))return 0}if(t.length===0)for(let s=0;s<r;s++)s!==e&&t.push(s);const a=Math.floor(Math.random()*t.length);return t[a]},applyAIIdentityForThree(){Number(this.player.num)===3&&(this.player.name[1]="小红",this.player.name[2]="小明")},getBallDx(e){let r=v;return this.player.isLeftWard[e]&&(r=0),r},onThrowBall(e){this.ball.owner==0&&this.throwBall(e)},async aiThrowBall(){if(this.gameOver)return;const e=this.getReceptorId(this.ball.owner);await p.sleep(j),!this.gameOver&&this.throwBall(e)},throwBall(e=0,r=.5){if(this.gameOver)return"game over";if(this.ball.moveDur=r,e==this.ball.owner)return"don't need to move the ball";if(this.setBallPos(e),this.ball.owner=e,this.scoreCounter(e),this.gameOver)return"game over";this.ball.owner>0&&this.aiThrowBall()},setBallPos(e){const r=this.getBallDx(e),[t,l]=this.getPlayerPos(e);if(!t||!l)return;const a=(t+r)/(window.innerWidth/100),s=(l-q)/L;this.ball.pos=[a,s]},resetBallPos(){this.ball.pos=[50-32/2/(window.innerWidth/100),(window.innerHeight-32)/L/2]},updateBallPosOnResize(){this.ball.moveDur=0,this.ball.owner||this.resetBallPos(),this.setBallPos(this.ball.owner)},shiftBallPos(e,r){this.ball.moveDur=r,this.ball.pos[0]+=e/(window.innerWidth/100)},initTopPlayerLimit(){try{this.topPlayerIdx=0;const e=new Date().getSeconds()%2===0;this.topPlayerLimit=e?10:3}catch(e){console.warn("initTopPlayerLimit failed",e),this.topPlayerIdx=0,this.topPlayerLimit=3}},restartGame(){this.gameOver=!1,this.endMsg="",this.score.throwCounts=0;for(let e=0;e<this.score.playerCounts.length;e++)this.score.playerCounts[e]=0;this.ball.moveDur=0,this.ball.owner=void 0,this.resetBallPos(),c.playerPos={},this.initTopPlayerLimit()}},mounted(){this.loadConfigs(),this.watchWindowResize(),this.$nextTick(()=>{var e,r,t,l;this.initTopPlayerLimit(),this.applyAIIdentityForThree(),this.trainingMode=((r=(e=this.$route)==null?void 0:e.query)==null?void 0:r.mode)==="training"||((l=(t=this.$store)==null?void 0:t.getters)==null?void 0:l.trainingMode)===!0})},beforeUpdate(){this.player.refs=[]}},K={class:"game-page"},Q={class:"main-page"},Z={key:0,class:"end-overlay"},ee={class:"end-modal"},te={class:"survey-placeholder"},re=["href"],se={key:1},ae={id:"menu-btn"};function le(e,r,t,l,a,s){const n=d("Player"),y=d("Ball"),C=d("ScoreBoard"),w=d("NavButton");return i(),u("div",K,[r[2]||(r[2]=o("h1",null,"CyberBall",-1)),o("div",Q,[o("div",{class:"players-wrap",onMousemove:r[0]||(r[0]=(..._)=>s.onPlayerTurn&&s.onPlayerTurn(..._))},[(i(!0),u(B,null,b(s.gridArea,(_,h)=>(i(),S(n,{key:h,ref_for:!0,ref:s.setPlayerRef,style:P(_),playerStyle:s.playerStyle[h],playerName:a.player.name[h],isLeftWard:a.player.isLeftWard[h],title:`分数：${a.score.playerCounts[h]}`,onMoveBall:N=>s.onThrowBall(h),onPlayerLoaded:N=>h===0?s.throwBall(0,0):null},null,8,["style","playerStyle","playerName","isLeftWard","title","onMoveBall","onPlayerLoaded"]))),128))],32)]),m(y,{posx:a.ball.pos[0],posy:a.ball.pos[1],moveDur:a.ball.moveDur},null,8,["posx","posy","moveDur"]),m(C,{throwNum:a.score.throwCounts,score:s.scoreRank},null,8,["throwNum","score"]),a.gameOver?(i(),u("div",Z,[o("div",ee,[r[1]||(r[1]=o("h2",null,"游戏结束",-1)),o("p",null,f(a.endMsg),1),o("div",te,[a.surveyUrl?(i(),u("a",{key:0,href:a.surveyUrl,target:"_blank",rel:"noopener"},"参与问卷",8,re)):(i(),u("span",se,"问卷链接占位"))]),m(w,{destination:"/",text:"返回"})])])):x("",!0),o("div",ae,[m(w,{destination:"/",text:"返回"})])])}const ie=g(J,[["render",le]]);export{ie as default};
