import{P as A}from"./PlayerImg-047c06da.js";import{_ as L,r as P,o as p,c as m,a as N,n as I,b as M,d as c,t as b,e as D,F as x,f as T,N as R,g as k,h as $,i as W}from"./index-d85eb2ce.js";const E={name:"Player",components:{PlayerImg:A},props:{isLeftWard:Boolean,playerStyle:String,playerName:String},emits:["moveBall","playerLoaded"]};function q(e,s,t,l,r,i){const o=P("PlayerImg");return p(),m("div",null,[N(o,{class:I(t.isLeftWard?"player-leftWard":"player-rightWard"),style:M(t.playerStyle),onClick:s[0]||(s[0]=n=>e.$emit("moveBall")),onLoad:s[1]||(s[1]=n=>e.$emit("playerLoaded"))},null,8,["class","style"]),c("p",null,b(t.playerName),1)])}const O=L(E,[["render",q]]);const G={name:"Ball",props:{posx:Number,posy:Number,moveDur:Number},computed:{ballStyle(){return`transform:translate(${this.posx}vw, ${this.posy}rem); transition: ${this.moveDur}s ease-out`}}};function F(e,s,t,l,r,i){return p(),m("img",{class:"ball",src:D,style:M(i.ballStyle)},null,4)}const z=L(G,[["render",F]]);const U={props:{throwNum:Number,score:Array}},X={class:"score-board"},V={class:"score-row"};function Y(e,s,t,l,r,i){return p(),m("div",X,[c("p",null,"目前球数："+b(t.throwNum),1),s[0]||(s[0]=c("p",null,"排行榜：",-1)),c("ol",null,[(p(),m(x,null,T(3,o=>c("li",{key:o},[c("div",V,[c("div",null,b(t.score[o-1].player),1),c("div",null,b(t.score[o-1].value),1)])])),64))])])}const H=L(U,[["render",Y]]),j={rect:{mode1:["3 / 2 / auto / 4","2 / 1","2 / 4","1 / 2 / auto / 4","3 / 3","1 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"],mode2:["3 / 2","2 / 1 / 4","2 / 4 / 4","1 / 2","3 / 3 / auto / 5","1 / 4 / 3","1 / 1 / 3","1 / 4 / 3","3 / 1 / auto / 3"]},modeMap:{3:[],4:[],5:[0],6:[0,3],7:[0,1,2,5],8:[0,1,2,3],9:[1,2,3,4]}},J=e=>{const s=e.map(t=>t*Math.random());return s.indexOf(Math.max(...s))},K=e=>{const s=[...e],t=[...e];s.sort((o,n)=>n-o);const l=t.indexOf(s[0]);t[l]=void 0;const r=t.indexOf(s[1]);t[r]=void 0;const i=t.indexOf(s[2]);return t[i]=void 0,[l,r,i]},Q=e=>new Promise(s=>{setTimeout(s,e)}),v={playerLayout:j,getRandomIdx:J,getTopIdx:K,sleep:Q};const B=16,S=67,Z=5,C=1e3,ee=5e3,_={playerPos:{}},te={components:{ScoreBoard:H,NavButton:R,Player:O,Ball:z},data(){return{score:{throwCounts:0,playerCounts:[0,0,0,0,0,0,0,0,0]},gameOver:!1,totalPassLimit:30,topPlayerIdx:null,topPlayerLimit:null,topPlayerSchedule:[],lastPlayer0Throw:null,endMsg:"",trainingMode:!1,showIntro:!0,showLoading:!1,waitSeconds:6,surveyUrl:"",player:{num:3,numInput:3,turnDur:0,filter:"sepia(1) saturate(20)",hue:180,gray:0,name:["player","player1","player2","player3","player4","player5","player6","player7","player8"],isLeftWard:[!1,!1,!0,!1,!0,!0,!1,!0,!1,!0],refs:[]},ball:{pos:[-10,-10],moveDur:0,owner:void 0},loadingRemaining:0,loadingElapsed:0,loadingTimer:null,showAlmostStart:!1,effectiveWait:0,aiPresetNamesEnabled:!1}},computed:{scoreRank(){const[e,s,t]=v.getTopIdx(this.score.playerCounts);return[{player:this.player.name[e],value:this.score.playerCounts[e]},{player:this.player.name[s],value:this.score.playerCounts[s]},{player:this.player.name[t],value:this.score.playerCounts[t]}]},playerStyle(){const e=(t,l,r)=>`filter: ${this.player.filter} hue-rotate(${t}deg) grayscale(${l}%); transition:${r}s linear`,s=[e(this.player.hue,this.player.gray,this.player.turnDur)];for(let t=1;t<this.player.num;t++)Number(this.player.num)===3&&t===1?s.push("filter: sepia(1) saturate(12) hue-rotate(190deg) brightness(0.95) contrast(1.15) grayscale(0%); transition:0s linear"):Number(this.player.num)===3&&t===2?s.push("filter: sepia(1) saturate(12) hue-rotate(330deg) brightness(1.0) contrast(1.10) grayscale(0%); transition:0s linear"):s.push(e(Math.random()*360,Math.random()*100,0));return s},gridArea(){const e=t=>v.playerLayout.modeMap[this.player.num].includes(t)?`grid-area: ${v.playerLayout.rect.mode2[t]}`:`grid-area: ${v.playerLayout.rect.mode1[t]}`,s=[];for(let t=0;t<this.player.num;t++)s.push(e(t));return s}},methods:{loadConfigs(){var n,u,d,a,h,y,f,g,w;const e=((n=this.$route)==null?void 0:n.query)||{},s=e.name?String(e.name):null,t=e.hue!==void 0?Number(e.hue):null,l=e.gray!==void 0?Number(e.gray):null,r=e.num!==void 0?Number(e.num):null;this.player.name[0]=s&&s.length>0?s:((d=(u=this.$store)==null?void 0:u.getters)==null?void 0:d.playerName)||this.player.name[0],!Number.isNaN(t)&&t!==null?this.player.hue=t:this.player.hue=((h=(a=this.$store)==null?void 0:a.getters)==null?void 0:h.playerHue)||this.player.hue,!Number.isNaN(l)&&l!==null?this.player.gray=l:this.player.gray=((f=(y=this.$store)==null?void 0:y.getters)==null?void 0:f.playerGray)||this.player.gray;let i=Number((w=(g=this.$store)==null?void 0:g.getters)==null?void 0:w.playerNum),o=!Number.isNaN(r)&&r>=3&&r<=9?r:!Number.isNaN(i)&&i>=3&&i<=9?i:this.player.num;this.player.num=o,this.player.numInput=o},scoreCounter(e){if(this.gameOver)return;if(this.trainingMode){this.score.throwCounts++,this.score.playerCounts[e]++,e===0&&(Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0&&this.topPlayerSchedule[0]===this.score.throwCounts&&this.topPlayerSchedule.shift(),this.lastPlayer0Throw=this.score.throwCounts);return}this.score.throwCounts++,this.score.playerCounts[e]++,e===0&&(Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0&&this.topPlayerSchedule[0]===this.score.throwCounts&&this.topPlayerSchedule.shift(),this.lastPlayer0Throw=this.score.throwCounts),this.score.throwCounts>=this.totalPassLimit&&(this.gameOver=!0,this.ball.moveDur=0,this.endMsg=`总传球数：${this.score.throwCounts}/${this.totalPassLimit}；你的接球数：${this.score.playerCounts[0]}`)},watchWindowResize(){window.addEventListener("resize",()=>{_.playerPos={},this.updateBallPosOnResize()},!1)},onPlayerTurn(e){const s=e.clientX;for(const t of[0]){const l=this.setPlayerDirection(s,t);if(l===-1)break;if(this.ball.owner==t){const r=l?-S:S;this.shiftBallPos(r,this.player.turnDur)}}},setPlayerRef(e){e&&this.player.refs.push(e.$el.childNodes[0])},setPlayerDirection(e,s){var l;if(!((l=this.player.refs[s])!=null&&l.offsetLeft))return-1;const t=e<this.player.refs[s].offsetLeft;return t==this.player.isLeftWard[s]?-1:(this.player.isLeftWard[s]=t,t)},getPlayerPos(e){var r,i;if(_.playerPos[e])return _.playerPos[e];const s=this.player.refs[e];if(!s)return console.log("reference error!"),[void 0,void 0];let t=(r=s.getClientRects()[0])==null?void 0:r.left,l=(i=s.getClientRects()[0])==null?void 0:i.top;return t!==void 0&&l!==void 0&&(_.playerPos[e]=[t,l]),[t,l]},getReceptorId(e){const s=this.player.num;let t=[];for(let n=0;n<s;n++)n!==e&&t.push(n);if(this.trainingMode){const n=Math.floor(Math.random()*t.length);return t[n]}const l=this.topPlayerIdx===0&&this.topPlayerLimit!==null&&this.score.playerCounts[0]>=this.topPlayerLimit,r=this.score.throwCounts+1,i=Array.isArray(this.topPlayerSchedule)&&this.topPlayerSchedule.length>0;if(l)t=t.filter(n=>n!==0);else if(i){if(e!==0&&t.includes(0)&&this.topPlayerSchedule[0]===r)return 0;t=t.filter(n=>n!==0)}if(t.length===0)for(let n=0;n<s;n++)n!==e&&t.push(n);const o=Math.floor(Math.random()*t.length);return t[o]},applyAIIdentityForThree(){Number(this.player.num)===3&&(!this.trainingMode&&this.aiPresetNamesEnabled?(this.player.name[1]="王佳琪",this.player.name[2]="刘明宇"):(this.player.name[1]="player1",this.player.name[2]="player2"))},getBallDx(e){let s=S;return this.player.isLeftWard[e]&&(s=0),s},onThrowBall(e){this.ball.owner==0&&this.throwBall(e)},async aiThrowBall(){if(this.gameOver)return;const e=this.getReceptorId(this.ball.owner),s=C+Math.floor(Math.random()*(ee-C+1));await v.sleep(s),!this.gameOver&&this.throwBall(e)},throwBall(e=0,s=.5){if(this.gameOver)return"game over";if(this.ball.moveDur=s,e==this.ball.owner)return"don't need to move the ball";if(this.setBallPos(e),this.ball.owner=e,this.scoreCounter(e),this.gameOver)return"game over";this.ball.owner>0&&this.aiThrowBall()},setBallPos(e){const s=this.getBallDx(e),[t,l]=this.getPlayerPos(e);if(!t||!l)return;const r=(t+s)/(window.innerWidth/100),i=(l-Z)/B;this.ball.pos=[r,i]},resetBallPos(){this.ball.pos=[50-32/2/(window.innerWidth/100),(window.innerHeight-32)/B/2]},updateBallPosOnResize(){this.ball.moveDur=0,this.ball.owner||this.resetBallPos(),this.setBallPos(this.ball.owner)},shiftBallPos(e,s){this.ball.moveDur=s,this.ball.pos[0]+=e/(window.innerWidth/100)},initTopPlayerLimit(){var e;try{this.topPlayerIdx=0;const s=new URLSearchParams(window.location.search||""),t=d=>{const a=["cfg","k","limit"];let h=null;for(const g of a){const w=d.get?d.get(g):d[g];if(w!=null){h=w;break}}if(h===null)return NaN;const y=String(h).toLowerCase();if(y==="a"||y==="alpha")return 3;if(y==="b"||y==="beta")return 10;const f=Number(y);return Number.isNaN(f)?NaN:f===3||f===10?f:NaN},l=t(s),r=((e=this.$route)==null?void 0:e.query)||{},i=t({get:d=>r[d]});let o;const n=/(^|\?|&)\s*cfg=b(\b|&|$)/i.test(window.location.search||"");n?o=10:!Number.isNaN(l)&&l>0?o=l:!Number.isNaN(i)&&i>0?o=i:o=10,this.topPlayerLimit=n?10:o===3||o===10?o:10;const u={3:"https://www.wjx.cn/vm/w3u3XJs.aspx",10:"https://www.wjx.cn/vm/OPiCEuk.aspx"};this.surveyUrl=u[this.topPlayerLimit]||""}catch(s){console.warn("initTopPlayerLimit failed",s),this.topPlayerIdx=0,this.topPlayerLimit=10}finally{this.topPlayerSchedule=this.buildEvenSchedule(this.totalPassLimit,this.topPlayerLimit)}},buildEvenSchedule(e,s){try{if(!s||s<=0)return[];const t=s,l=[];for(let a=1;a<=t;a++)l.push(a*(e+1)/(t+1));const r=e/(t+1),i=Math.max(1,Math.floor(r*.35));let o=l.map(a=>{const h=Math.floor((Math.random()*2-1)*i),y=Math.round(a+h);return Math.min(Math.max(y,1),e)});o.sort((a,h)=>a-h);const n=Math.max(1,Math.floor(r*.4)),u=[];for(let a=0;a<t;a++){let h=o[a];if(a===0){const y=e-(t-1)*n;h=Math.min(h,Math.max(1,y))}else h=Math.max(h,u[a-1]+n);u.push(h)}let d=u[t-1]-e;if(d>0)for(let a=t-1;a>=0&&d>0;a--){const h=a>0?u[a-1]:0,y=a===0?1:h+n,f=Math.max(0,u[a]-y);if(f>0){const g=Math.min(f,d);u[a]-=g,d-=g}}for(let a=0;a<t;a++)a===0?u[a]=Math.min(Math.max(u[a],1),e-(t-1)*n):u[a]=Math.min(Math.max(u[a],u[a-1]+n),e-(t-1-a)*n);return u.map(a=>Math.round(a))}catch(t){return console.warn("buildEvenSchedule failed",t),[]}},onPlayerLoaded(e){e===0&&(this.showIntro||(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0))},async startGame(){if(this.showIntro=!1,this.trainingMode)this.showLoading=!1;else{const t=Date.now(),l=d=>{const f=(d*1664525+1013904223)%4294967296;return{r:f/4294967296,seed:f}};let r=l(t);this.waitSeconds=15+Math.floor(r.r*(60-15+1));const i=Math.min(5,this.waitSeconds-15);let o=l(r.seed);const n=Math.floor(o.r*(i+1)),u=this.waitSeconds-n;this.effectiveWait=u,this.showAlmostStart=!1,this.loadingElapsed=0,this.aiPresetNamesEnabled=!1,this.applyAIIdentityForThree(),this.loadingRemaining=u,this.showLoading=!0,this.loadingTimer=setInterval(()=>{this.loadingRemaining>0?(this.loadingRemaining--,this.loadingElapsed++,this.loadingRemaining===5&&(this.aiPresetNamesEnabled=!0,this.applyAIIdentityForThree()),this.showAlmostStart=this.loadingRemaining<=5&&this.loadingRemaining>0):(clearInterval(this.loadingTimer),this.loadingTimer=null)},1e3),await v.sleep(u*1e3),this.showLoading=!1,this.loadingTimer&&(clearInterval(this.loadingTimer),this.loadingTimer=null),this.loadingRemaining=0,this.loadingElapsed=0,this.showAlmostStart=!1,this.effectiveWait=0}this.player.refs[0]?(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0):this.$nextTick(()=>{this.gameOver||(this.setBallPos(0),this.ball.owner=0,this.ball.moveDur=0)})},restartGame(){this.loadingTimer&&(clearInterval(this.loadingTimer),this.loadingTimer=null),this.loadingRemaining=0,this.loadingElapsed=0,this.showAlmostStart=!1,this.effectiveWait=0,this.gameOver=!1,this.endMsg="",this.score.throwCounts=0;for(let e=0;e<this.score.playerCounts.length;e++)this.score.playerCounts[e]=0;this.ball.moveDur=0,this.ball.owner=void 0,this.resetBallPos(),_.playerPos={},this.lastPlayer0Throw=null,this.initTopPlayerLimit()}},mounted(){try{["playerName","playerHue","playerGray","playerNum","isSave","cb_topPlayerLimit"].forEach(s=>localStorage.removeItem(s))}catch{}this.loadConfigs(),this.watchWindowResize(),this.$nextTick(()=>{var r,i,o,n,u,d,a,h,y,f,g,w;this.initTopPlayerLimit();const e=new URLSearchParams(window.location.search||"");e.get("cfg")!==null||e.get("k")!==null||e.get("limit")!==null||(((i=(r=this.$route)==null?void 0:r.query)==null?void 0:i.cfg)??null)!==null||(((n=(o=this.$route)==null?void 0:o.query)==null?void 0:n.k)??null)!==null||(((d=(u=this.$route)==null?void 0:u.query)==null?void 0:d.limit)??null)!==null?this.trainingMode=!1:this.trainingMode=((h=(a=this.$route)==null?void 0:a.query)==null?void 0:h.mode)==="training";const t=Number((f=(y=this.$route)==null?void 0:y.query)==null?void 0:f.wait),l=Number((w=(g=this.$store)==null?void 0:g.getters)==null?void 0:w.waitSeconds);!Number.isNaN(t)&&t>0?this.waitSeconds=t:!Number.isNaN(l)&&l>0&&(this.waitSeconds=l),this.aiPresetNamesEnabled=!1,this.applyAIIdentityForThree()})},beforeUpdate(){this.player.refs=[]}},se={class:"game-page"},re={class:"main-page"},ae={key:0,class:"end-overlay"},le={class:"end-modal"},ie={class:"intro-text"},ne={key:0},oe={key:1},he={key:1,class:"end-overlay"},ce={class:"end-modal"},ue={key:0},de={key:1},ye={class:"loading-wrap"},pe={key:0,class:"loading-spinner"},me={key:1,class:"ready-indicator sk-fading-circle","aria-label":"玩家已就绪"},fe={class:"loading-text"},ge={key:0},we={key:1},ve={key:2,class:"end-overlay"},_e={class:"end-modal"},Pe={class:"survey-placeholder"},Ne=["href"],be={key:1},Le={id:"menu-btn"};function ke(e,s,t,l,r,i){const o=P("Player"),n=P("Ball"),u=P("ScoreBoard"),d=P("NavButton");return p(),m("div",se,[s[7]||(s[7]=c("h1",null,"CyberBall",-1)),c("div",re,[c("div",{class:"players-wrap",onMousemove:s[0]||(s[0]=(...a)=>i.onPlayerTurn&&i.onPlayerTurn(...a))},[(p(!0),m(x,null,T(i.gridArea,(a,h)=>(p(),W(o,{key:h,ref_for:!0,ref:i.setPlayerRef,style:M(a),playerStyle:i.playerStyle[h],playerName:r.player.name[h],isLeftWard:r.player.isLeftWard[h],title:`分数：${r.score.playerCounts[h]}`,onMoveBall:y=>i.onThrowBall(h),onPlayerLoaded:y=>i.onPlayerLoaded(h)},null,8,["style","playerStyle","playerName","isLeftWard","title","onMoveBall","onPlayerLoaded"]))),128))],32)]),N(n,{posx:r.ball.pos[0],posy:r.ball.pos[1],moveDur:r.ball.moveDur},null,8,["posx","posy","moveDur"]),N(u,{throwNum:r.score.throwCounts,score:i.scoreRank},null,8,["throwNum","score"]),r.showIntro?(p(),m("div",ae,[c("div",le,[s[4]||(s[4]=c("h2",null,"玩法说明",-1)),c("div",ie,[r.trainingMode?(p(),m("p",oe,"现在进入练习环节，在屏幕上你会看到三个人物进行传球游戏 ")):(p(),m("p",ne,"现在进入到正式的实验环节，在屏幕上你会看到三个人物进行传球游戏 ")),s[2]||(s[2]=c("ul",null,[c("li",null,"屏幕底部的人物是你自己。"),c("li",null,"另外两个人物是在其它房间进行实验的另外两个人"),c("li",null,"你们之间会互相进行传球，每一次你可以选择将球传给其中一人 ")],-1)),s[3]||(s[3]=c("p",null,"准备好了请点击“进入游戏” ",-1))]),c("button",{onClick:s[1]||(s[1]=(...a)=>i.startGame&&i.startGame(...a))},"进入游戏")])])):k("",!0),r.showLoading&&!r.trainingMode?(p(),m("div",he,[c("div",ce,[r.showAlmostStart?(p(),m("h2",de,"匹配就绪，游戏房间资源加载中")):(p(),m("h2",ue,"正在等待其他玩家准备中……")),c("div",ye,[r.showAlmostStart?(p(),m("div",me,[...s[5]||(s[5]=[$('<span class="sk-circle1 sk-circle"></span><span class="sk-circle2 sk-circle"></span><span class="sk-circle3 sk-circle"></span><span class="sk-circle4 sk-circle"></span><span class="sk-circle5 sk-circle"></span><span class="sk-circle6 sk-circle"></span><span class="sk-circle7 sk-circle"></span><span class="sk-circle8 sk-circle"></span><span class="sk-circle9 sk-circle"></span><span class="sk-circle10 sk-circle"></span><span class="sk-circle11 sk-circle"></span><span class="sk-circle12 sk-circle"></span>',12)])])):(p(),m("div",pe)),c("div",fe,[r.showAlmostStart?(p(),m("span",ge,"玩家已就绪，正在进入…")):(p(),m("span",we,"请稍候，游戏即将开始…"))])])])])):k("",!0),r.gameOver?(p(),m("div",ve,[c("div",_e,[s[6]||(s[6]=c("h2",null,"游戏结束",-1)),c("p",null,b(r.endMsg),1),c("div",Pe,[r.surveyUrl?(p(),m("a",{key:0,href:r.surveyUrl,target:"_blank",rel:"noopener"},"参与问卷",8,Ne)):(p(),m("span",be,"问卷链接占位"))]),N(d,{destination:"/",text:"返回"})])])):k("",!0),c("div",Le,[N(d,{destination:"/",text:"返回"})])])}const Be=L(te,[["render",ke]]);export{Be as default};
